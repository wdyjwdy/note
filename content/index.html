<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="/static/page/heart.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="/static/page/common.css" />
  <title>ノート</title>
</head>

<body>
  <h1>ノート</h1>
  <input type="search" id="search-button" />
  <div class="filter-buttons"></div>
  <div class="search-result"></div>
</body>

<script>
  const pages = '@pages'
  const groups = new Set(pages.map(p => p.group))
  const searchButton = document.querySelector("#search-button");
  const filterButtons = document.querySelector(".filter-buttons");
  const searchResult = document.querySelector(".search-result");

  // create buttons
  for (let group of groups) {
    filterButtons.insertAdjacentHTML("beforeend", `<button>${group}</button>`)
  }

  filterButtons.addEventListener("click", function (event) {
    if (event.target.tagName === "BUTTON") {
      searchButton.value = event.target.textContent;
      searchButton.dispatchEvent(new Event('input', {bubbles: true}));
    }
  });

  searchButton.addEventListener("input", function (event) {
    searchResult.replaceChildren();
    const query = this.value;
    pages
      .filter(({title, group, alias = []}) => {
        const keys = [title, group, ...alias]
        const regex = new RegExp(query, "i")
        return keys.some(x => regex.test(x))
      })
      .forEach((x, i, a) => {
        const prevGroup = a[i - 1]?.group;
        if (x.group !== prevGroup) {
          searchResult.insertAdjacentHTML("beforeend", `<p>${x.group}</p>`);
        }
        let item = `<a href="${x.path}">${x.title}<span>${x.mtime}</span></a>`
        if (x.alias) {
          item = `<a href="${x.path}">${x.alias.join('、')}<span>${x.mtime}</span></a>`
        }
        searchResult.insertAdjacentHTML("beforeend", item);
      });
  });

  searchButton.addEventListener("keydown", function (event) {
    if (event.code === "Enter") {
      setTimeout(() => this.blur(), 0);　// close keyboard (safari)
    }
  });
</script>

<style>
  html {
    font-family: Hiragino Sans GB;
  }

  #search-button {
    margin: 20px 0;
    font-size: 1em;
    width: 100%;
    font-family: inherit;
    color: inherit;
  }

  .filter-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 2px;

    button {
      font-size: 1em;
      font-family: inherit;
    }
  }

  .search-result {
    margin: 20px 0;
    display: flex;
    flex-direction: column;
    gap: 10px;

    p {
      border-bottom: 1px solid light-dark(oklch(0.9 0 0), oklch(0.4 0 0));
      margin: 0;
    }

    a {
      display: flex;
      justify-content: space-between;
    }

    span {
      color: gray;
      flex-shrink: 0;
    }
  }
</style>

</html>